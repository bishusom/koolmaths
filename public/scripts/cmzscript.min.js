let config={kinder:{name:"Kindergarten Questers 🐛➡🦋",operations:["+"],maxNumber:10,time:90,emoji:"📚",correctPoints:10,wrongPenalty:0,speedBonusThreshold:3,speedBonusMultiplier:1.5,streakBonus:3,basePoints:10,penaltyMultiplier:1.2},primary1:{name:"Grade 1-3 Number Ninjas 🥷✨",operations:["+","-"],maxNumber:30,time:90,emoji:"🎒",correctPoints:15,wrongPenalty:2,speedBonusThreshold:3,speedBonusMultiplier:1.7,streakBonus:3,basePoints:15,penaltyMultiplier:1.3},primary2:{name:"Grade 4-6 Math Mavericks 🤠🔢",operations:["BODMAS","÷",,"×","²"],maxNumber:100,time:120,emoji:"🧮",correctPoints:20,wrongPenalty:5,maxAttempts:15,patterns:["(a ± b) × (c ± d)","a × (b ± c) ÷ d","(a + b) × c - d","a ÷ (b ± c)","(a × b) + (c × d)","a - (b × c) ÷ d","(a + b) ÷ (c - d)","a² ± b × c"],speedBonusThreshold:5,speedBonusMultiplier:2.5,streakBonus:4,basePoints:25,penaltyMultiplier:1.6},secondary:{name:"Grade 7-8 Algebra Avengers 🦸♂️📐",operations:["eq","√","()"],maxNumber:150,time:120,emoji:"⚡",correctPoints:25,wrongPenalty:10,maxAttempts:15,speedBonusThreshold:5,speedBonusMultiplier:2.5,streakBonus:3,basePoints:25,penaltyMultiplier:1.5},genius:{name:"Math Megastars 🌟🧠",operations:["eq","²","√","()","π"],maxNumber:200,time:120,emoji:"🎇",correctPoints:30,wrongPenalty:15,equationChance:.7,maxAttempts:20,speedBonusThreshold:5,speedBonusMultiplier:3,streakBonus:5,basePoints:30,penaltyMultiplier:2}},score=0,timeLeft=0,gameActive=!1,currentProblem=null,timerInterval=null,totalQuestions=0,correctAnswers=0,currentStreak=0,remainingTime=0,problemHistory=[],pendingTimeout=null,isPaused=!1,isMuted="true"===localStorage.getItem("muteState"),currentLevel=localStorage.getItem("lastLevel")||"kinder",lastSelectedLevel=currentLevel,elements={tagLine:document.querySelector(".tagline"),themeToggleBtn:document.getElementById("themeToggleBtn"),startBtn:document.getElementById("startBtn"),euPrivacy:document.getElementById("eu-privacy"),gameContainer:document.querySelector(".game-container"),levelSelector:document.querySelector(".level-selector"),levelBtns:document.querySelectorAll(".level-btn"),muteBtn:document.getElementById("muteBtn"),pauseBtn:document.getElementById("pauseBtn"),scoreElement:document.getElementById("score"),timerElement:document.getElementById("timer"),problemElement:document.getElementById("problem"),answersContainer:document.getElementById("answers"),feedbackElement:document.getElementById("answerFeedback"),gameOverScreen:document.querySelector(".game-over"),finalScore:document.getElementById("finalScore"),performanceMessage:document.getElementById("performanceMessage"),playAgainBtn:document.getElementById("playAgainBtn"),correctSound:document.getElementById("correctSound"),wrongSound:document.getElementById("wrongSound"),tickSound:document.getElementById("tickSound"),bonusSound:document.getElementById("bonusSound"),gameOverSound:document.getElementById("gameOverSound"),currentLevelEmoji:document.getElementById("currentLevelEmoji"),currentLevelName:document.getElementById("currentLevelName"),performanceMeter:document.createElement("div"),performanceBar:document.createElement("div"),feedbackForm:document.getElementById("feedbackForm"),cancelFeedback:document.getElementById("cancelFeedback"),closeFeedbackBtn:document.getElementById("closeFeedbackBtn"),formContent:document.querySelector(".form-content"),feedbackSuccess:document.querySelector(".feedback-success")},MAX_HISTORY=(elements.muteBtn.style.display="none",elements.pauseBtn.style.display="none",10),GA_TRACKING_ID="G-SHMYVQ4TGH",maxScoreDisplay=(elements.performanceMeter.className="performance-meter",elements.performanceBar.className="performance-bar",elements.performanceMeter.appendChild(elements.performanceBar),document.createElement("div"));function showFeedbackForm(){elements.feedbackForm.classList.remove("hidden"),elements.feedbackForm.scrollIntoView({behavior:"smooth"}),trackEvent("Engagement","Feedback Form Viewed","From Link",0)}function trackEvent(e,t,n,r){"function"==typeof gtag&&gtag("event",t,{event_category:e,event_label:n,value:r})}function toggleMute(e){isMuted="boolean"==typeof e?e:!isMuted,localStorage.setItem("muteState",isMuted),elements.muteBtn.querySelector(".icon").textContent=isMuted?"🔇":"🔊",elements.muteBtn.classList.toggle("muted",isMuted),isMuted&&Object.values(elements).forEach(e=>{e instanceof HTMLAudioElement&&(e.pause(),e.currentTime=0)})}function togglePause(){var e;isPaused=!isPaused,elements.pauseBtn.classList.toggle("paused",isPaused),isPaused?(stopSound(elements.tickSound),(e=document.createElement("div")).className="pause-overlay",e.textContent="PAUSED",document.body.appendChild(e),remainingTime=timeLeft,clearInterval(timerInterval),document.querySelectorAll(".answer-btn").forEach(e=>e.disabled=!0)):(document.querySelector(".pause-overlay")?.remove(),timeLeft=remainingTime,timerInterval=setInterval(updateTimer,1e3),document.querySelectorAll(".answer-btn").forEach(e=>e.disabled=!1),timeLeft<=10&&playSound(elements.tickSound))}function toggleTheme(){var e="dark"===document.body.getAttribute("data-theme"),t=e?"light":"dark";document.body.setAttribute("data-theme",t),elements.themeToggleBtn.querySelector(".icon").textContent=e?"🌙":"☀️",localStorage.setItem("theme",t)}function playSound(e){!isMuted&&e&&(e.currentTime=0,e.play().catch(()=>{}))}function stopSound(e){e&&(e.pause(),e.currentTime=0)}function setLevel(t){currentLevel=t,lastSelectedLevel=t,localStorage.setItem("lastLevel",t),elements.levelBtns.forEach(e=>{e.classList.toggle("active",e.dataset.level===t)})}function generateProblem(){var e=config[currentLevel];let t,n=0;do{n++;try{("primary2"===currentLevel?generateBodmasProblem:"secondary"===currentLevel||"genius"===currentLevel?generateAdvancedProblem:generateBasicProblem)(e),t=currentProblem.problemText}catch(e){currentProblem=generateFallbackProblem();break}}while(!(5<n)&&problemHistory.includes(t));problemHistory.push(t),problemHistory.length>MAX_HISTORY&&problemHistory.shift(),totalQuestions++,showAnswers()}function generateBasicProblem(e){var t=e.operations[Math.floor(Math.random()*e.operations.length)];let n,r,a,o="";switch(currentProblem={},currentLevel){case"kinder":n=randomNumber(5),r=randomNumber(10-n),o=createEmojiVisual(n,r);break;case"primary1":r="-"===t?(n=randomNumber(e.maxNumber,10),randomNumber(n,1)):(n=randomNumber(e.maxNumber,5),randomNumber(e.maxNumber,5));break;default:n=randomNumber(e.maxNumber),r=randomNumber(e.maxNumber)}switch(t){case"+":a=n+r;break;case"-":a=n-r;break;case"×":a=n*r;break;case"÷":r=randomNumber(12,1),a=randomNumber(12),n=r*a}currentProblem={problemText:`${n} ${t} ${r} = ?`,correctAnswer:a,emojiVisual:o}}function generateAdvancedProblem(e){var t={secondary:[generateLinearEquation,generateParenthesisEquation,generateSquareEquation],genius:[generateComplexEquation,generateQuadraticEquation,generateSquareEquation,generateSqrtEquation,generateFractionEquation,generateAlgebraicExpression]};let n=0;for(;n<10;){var r=(0,t[currentLevel][Math.floor(Math.random()*t[currentLevel].length)])();if(r&&validateAnswer(r.correctAnswer))return void(currentProblem=r);n++}currentProblem=generateFallbackProblem()}function generateLinearEquation(){var e=randomNumber(20,1),t=randomNumber(12,2),n=randomNumber(30,1);return{problemText:`Solve for x: ${t}x + ${n} = `+(t*e+n),correctAnswer:e}}function generateParenthesisEquation(){var e=randomNumber(20,1),t=randomNumber(10,2),n=randomNumber(15,1);return{problemText:`Solve for x: ${t}(x - ${n}) = `+t*(e-n),correctAnswer:e}}function generateSquareEquation(){var e,t,n;return"genius"===currentLevel?(e=randomNumber(15,1),{problemText:(t=randomNumber(9,2))+`x² + ${n=randomNumber(20,1)}x = `+(t*e*e+n*e),correctAnswer:e}):(t=randomNumber(15,1),{problemText:(n=randomNumber(9,2))+"x² = "+n*t**2,correctAnswer:t})}function generateComplexEquation(){var e=randomNumber(20,1),t=randomNumber(12,2),n=randomNumber(12,2),r=randomNumber(10,1);return{problemText:`Solve for x: ${t}(x + ${r}) = ${n}x + `+((t-n)*e+t*r),correctAnswer:e}}function generateQuadraticEquation(){var e=-randomNumber(5,1);return{problemText:`Solve for x: x² + ${2*e}x + ${e*e} = 0`,correctAnswer:-e}}function generateSqrtEquation(){var e,t,n;return"secondary"===currentLevel?{problemText:`√${(e=randomNumber(20,2))**2} = ?`,correctAnswer:e}:(e=randomNumber(5,2),t=randomNumber(10,1),{problemText:`√(${n=randomNumber(3,1)}x + ${e**2-n*t}) = `+e,correctAnswer:t})}function generateFractionEquation(){randomNumber(20,1);var e=randomNumber(10,2),t=randomNumber(40,10),n=t/e;return{problemText:`Solve for x: (${t} + x)/${e} = `+n,correctAnswer:n*e-t}}function generateAlgebraicExpression(){var e=randomNumber(20,5),t=randomNumber(15,5),n=randomNumber(10,2),r=randomNumber(20);return{problemText:`(${e} + ${t}) × ${n} - ${r} = ?`,correctAnswer:(e+t)*n-r}}function generateBodmasProblem(e){let t=0;for(;t<e.maxAttempts;){t++;try{var n=e.patterns[Math.floor(Math.random()*e.patterns.length)],r=buildExpression(n,generateSafeNumbers(n)),a=calculateAnswer(r);if(validateAnswer(a))return void(currentProblem={problemText:formatExpression(r),correctAnswer:a})}catch(e){console.error("BODMAS generation error:",e)}}currentProblem=generateFallbackProblem()}function showAnswers(){elements.answersContainer.innerHTML="";for(var n=[(currentProblem=currentProblem||generateFallbackProblem()).correctAnswer],r=currentProblem.correctAnswer,a=r%10;n.length<4;){let t;if(["secondary","genius"].includes(currentLevel)){let e=0;for(;t=r+randomNumber(40,-30),3<++e&&t%10==a&&(t+=randomNumber(9,1)),t<=0||t===r||n.includes(t)||t%10==a&&e<=10;);}else(t=r+randomNumber(3,-2))<=0&&(t=r+2);n.includes(t)||n.push(t)}"kinder"===currentLevel?elements.problemElement.innerHTML=`
            ${currentProblem.problemText}
            <div class="emoji-visual">
                ${currentProblem.emojiVisual}
            </div>    
            `:elements.problemElement.textContent=currentProblem.problemText,n.sort(()=>Math.random()-.5).forEach(e=>{var t=document.createElement("button");t.className="answer-btn",t.textContent=e,t.onclick=()=>checkAnswer(e),elements.answersContainer.appendChild(t)})}function startGame(){clearInterval(timerInterval),clearTimeout(pendingTimeout),elements.currentLevelEmoji.textContent=config[currentLevel].emoji,elements.levelSelector.classList.add("hidden"),elements.startBtn.classList.add("hidden"),elements.gameContainer.classList.remove("hidden"),elements.tagLine.classList.add("hidden"),elements.euPrivacy.classList.add("hidden"),trackEvent("Gameplay","Game Started",config[currentLevel].name,0),elements.muteBtn.style.display="flex",elements.pauseBtn.style.display="flex",elements.themeToggleBtn.style.display="none",elements.pauseBtn.disabled=!1,gameActive=!0,isPaused=!1,resetState(),generateProblem(),timerInterval=setInterval(updateTimer,1e3)}function resetState(){score=0,timeLeft=config[currentLevel].time,totalQuestions=0,correctAnswers=0,currentStreak=0,problemHistory=[],currentProblem=null,elements.scoreElement.textContent="0",elements.timerElement.textContent=timeLeft,elements.feedbackElement.classList.remove("visible"),elements.performanceBar.style.width="0%",elements.performanceBar.style.background="linear-gradient(90deg, #ff7675, #fdcb6e)";document.querySelector(".max-score-display").textContent={kinder:200,primary1:300,primary2:600,secondary:800,genius:1e3}[currentLevel]}function updateTimer(){isPaused||(timeLeft--,(elements.timerElement.textContent=timeLeft)<=10&&(playSound(elements.tickSound),timeLeft<=0)&&endGame())}function endGame(){gameActive=!1,stopSound(elements.tickSound),clearInterval(timerInterval),clearTimeout(pendingTimeout),localStorage.removeItem("maxScoreIncrease_"+currentLevel),elements.gameContainer.classList.add("hidden"),elements.gameOverScreen.classList.remove("hidden"),elements.tagLine.classList.remove("hidden"),elements.euPrivacy.classList.remove("hidden"),playSound(elements.gameOverSound),elements.pauseBtn.disabled=!0;let t=score+Math.floor(.7*timeLeft),n=totalQuestions;trackEvent("Gameplay","Game Completed",config[currentLevel].name,t);var e=[{message:"🏆 Math Megastar! 🧠",minScore:300,minAnswered:15},{message:"🔥 Brilliant Grinder! ⏳",minScore:200,minAnswered:10},{message:"📚 Steady Achiever! ✨",minScore:100,minAnswered:5},{message:"🌱 Keep Growing! 🌿",minScore:0,minAnswered:0}],e=e.find(e=>t>=e.minScore&&n>=e.minAnswered)||e[3];elements.performanceMessage.textContent=e.message,elements.finalScore.textContent=t}function checkAnswer(n){if(gameActive&&!isPaused){clearTimeout(pendingTimeout);var n=n===currentProblem.correctAnswer,r=config[currentLevel];let e=0,t="";var a,o=document.createElement("div"),s=(o.className="performance-change",{kinder:200,primary1:300,primary2:600,secondary:800,genius:1e3}),l=s[currentLevel],m=localStorage.getItem("maxScoreIncrease_"+currentLevel)||0,m=(l+=parseInt(m),document.querySelector(".max-score-display").textContent=l,n?(currentStreak++,e=r.basePoints,currentStreak>=r.streakBonus&&(a=Math.round(r.basePoints*r.speedBonusMultiplier),e+=a,t=`<div class="streak-feedback">🔥 ${currentStreak} ✅ In-A-Row! +${a} bonus</div>`,o.textContent=`+${a}!`,o.style.color="#fdcb6e",elements.performanceBar.appendChild(o)),score+=e,correctAnswers++,playSound(elements.correctSound),o.textContent="+"+r.basePoints,o.style.color="#00b894",elements.performanceBar.appendChild(o),score>=l&&10<timeLeft&&(a=parseInt(m)+200,localStorage.setItem("maxScoreIncrease_"+currentLevel,a.toString()),(m=document.createElement("div")).className="performance-change",m.textContent="MAX+200!",m.style.color="#00b894",m.style.fontWeight="bold",m.style.animation="floatUp 1.5s ease-out forwards",elements.performanceBar.appendChild(m),showBonusRoundMessage(),playSound(elements.bonusSound),document.querySelector(".max-score-display").textContent=l+200)):(currentStreak=0,a=r.wrongPenalty,score=Math.max(0,score-a),playSound(elements.wrongSound),o.textContent="-"+a,o.style.color="#ff7675",elements.performanceBar.appendChild(o)),s[currentLevel]+(parseInt(localStorage.getItem("maxScoreIncrease_"+currentLevel))||0)),l=Math.min(100,score/m*100);elements.performanceBar.style.width=l+"%",elements.performanceBar.style.background=75<l?"linear-gradient(90deg, #00b894, #55efc4)":50<l?"linear-gradient(90deg, #fdcb6e, #ffeaa7)":25<l?"linear-gradient(90deg, #fab1a0, #ff7675)":"linear-gradient(90deg, #ff7675, #d63031)",elements.scoreElement.textContent=score,elements.feedbackElement.classList.remove("wrong"),elements.feedbackElement.classList.add("visible",n?"correct":"wrong"),elements.feedbackElement.innerHTML=n?`<div>🎉 Correct! 🎉 +${e}</div>`+t:`<div>❌ Wrong! ❌ -${r.wrongPenalty}</div>
           <div class="correct-answer">Correct: ${currentProblem.correctAnswer}</div>`,document.querySelectorAll(".answer-btn").forEach(e=>{e.disabled=!0,e.classList.add(Number(e.textContent)===currentProblem.correctAnswer?"correct":"wrong")}),pendingTimeout=setTimeout(()=>{gameActive&&(generateProblem(),elements.feedbackElement.classList.remove("visible"))},1500)}}function generateFallbackProblem(){var e,t;return console.log(currentLevel),"kinder"===currentLevel?{problemText:(e=randomNumber(5))+` + ${t=randomNumber(10-e)} = ?`,correctAnswer:e+t,emojiVisual:createEmojiVisual(e,t)}:"primary1"===currentLevel?{problemText:(e=randomNumber(30,1))+` + ${t=randomNumber(30,1)} = ?`,correctAnswer:e+t}:{problemText:(e=randomNumber(99,19))+` × ${t=randomNumber(11,19)} = ?`,correctAnswer:e*t}}function generateSafeNumbers(e){var t={a:randomNumber(15,2),b:randomNumber(15,2),c:randomNumber(12,2),d:randomNumber(12,2)};return e.includes("÷")&&(e.includes("(b + c)")&&(t.c=randomNumber(5,1),t.a=(t.b+t.c)*randomNumber(5,1)),e.includes("÷ b"))&&(t.b=randomNumber(10,2),t.a=t.b*randomNumber(10,2)),e.includes("-")&&(t.a=Math.max(t.a,t.b+1)),t}function buildExpression(e,t){let n=e.replace(/±/g,.5<Math.random()?"+":"-");return(n=n.replace(/[abcd]/g,e=>t[e])).replace(/×/g,"*").replace(/÷/g,"/")}function formatExpression(e){return e.replace(/\*/g,"×").replace(/\//g,"÷").replace(/\d+/g,e=>parseInt(e).toLocaleString()).replace(/Math\.sqrt\((\d+)\)/g,"√$1")+" = ?"}function calculateAnswer(expr){try{return eval(expr)}catch{return null}}function validateAnswer(e){return Number.isInteger(e)&&0<e}function randomNumber(e,t=1){return Math.floor(Math.random()*(e-t+1))+t}function createEmojiVisual(e,t){var n=["🍎","🌸","🚗","🦆","⚽","🍦"],n=n[Math.floor(Math.random()*n.length)];return n.repeat(e)+" + "+n.repeat(t)}function showBonusRoundMessage(){let e=isPaused,t=(isPaused||togglePause(),document.createElement("div"));t.className="bonus-round-message",t.innerHTML=`
        <div class="bonus-round-content">
            <div class="bonus-round-title">🌟 BONUS ROUND! 🌟</div>
            <div class="bonus-round-text">Max Score Increased by 200!</div>
            <div class="bonus-round-emoji">🔥⚡🎯</div>
        </div>
    `,document.body.appendChild(t),setTimeout(()=>{t.classList.add("fade-out"),setTimeout(()=>{t.remove(),!e&&isPaused&&togglePause()},1e3)},3e3)}maxScoreDisplay.className="max-score-display",elements.performanceMeter.appendChild(maxScoreDisplay),document.querySelector(".container").prepend(elements.performanceMeter),document.addEventListener("DOMContentLoaded",()=>{var e=localStorage.getItem("lastLevel"),e=(e&&setLevel(e),elements.themeToggleBtn.addEventListener("click",toggleTheme),localStorage.getItem("theme")||"light");document.body.setAttribute("data-theme",e),elements.themeToggleBtn.querySelector(".icon").textContent="dark"===e?"☀️":"🌙"}),document.querySelectorAll(".level-btn").forEach(e=>{e.addEventListener("click",()=>setLevel(e.dataset.level)),e.addEventListener("dblclick",()=>{setLevel(e.dataset.level),startGame()})}),elements.startBtn.addEventListener("click",startGame),elements.muteBtn.addEventListener("click",()=>toggleMute()),elements.pauseBtn.addEventListener("click",togglePause),elements.playAgainBtn.addEventListener("click",()=>{elements.gameOverScreen.classList.add("hidden"),elements.tagLine.classList.remove("hidden"),elements.levelSelector.classList.remove("hidden"),elements.startBtn.classList.remove("hidden"),elements.euPrivacy.classList.remove("hidden"),elements.gameContainer.classList.add("hidden"),elements.muteBtn.style.display="none",elements.pauseBtn.style.display="none",elements.themeToggleBtn.style.display="flex",score=0,timeLeft=0,problemHistory=[],elements.scoreElement.textContent="0",elements.timerElement.textContent="0",setLevel(lastSelectedLevel),toggleMute("true"===localStorage.getItem("muteState")),elements.performanceBar.style.width="0%",elements.performanceBar.style.background="linear-gradient(90deg, #ff7675, #fdcb6e)"}),elements.cancelFeedback.addEventListener("click",()=>{elements.feedbackForm.classList.add("hidden")}),elements.closeFeedbackBtn?.addEventListener("click",()=>{elements.feedbackForm.classList.add("hidden"),elements.formContent.classList.remove("hidden"),elements.feedbackSuccess.classList.remove("visible")}),document.getElementById("feedbackLink")?.addEventListener("click",function(e){e.preventDefault(),showFeedbackForm()}),document.querySelector('form[name="feedback"]').addEventListener("submit",function(e){e.preventDefault();let t=this;fetch("/",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(new FormData(t)).toString()}).then(()=>{elements.formContent.classList.add("hidden"),elements.feedbackSuccess.classList.add("visible"),t.reset()}).catch(e=>{alert("There was an error submitting your feedback. Please try again."),console.error(e)})}),toggleMute(isMuted),document.getElementById("open-cookie-settings")?.addEventListener("click",function(e){e.preventDefault(),document.getElementById("consent-modal").classList.remove("hidden")}),document.addEventListener("DOMContentLoaded",function(){let t=document.getElementById("consent-banner"),n=document.getElementById("consent-modal");var e=document.getElementById("accept-all"),r=document.getElementById("settings-btn"),a=document.getElementById("reject-all"),o=document.getElementById("save-preferences"),s=document.getElementById("modal-close");let l=document.getElementById("consent-form");function m(e){function t(){dataLayer.push(arguments)}localStorage.setItem("cookieConsent",JSON.stringify(e)),console.log("Consent set:",e),e.analytics&&(console.log("Loading analytics..."),window.dataLayer=window.dataLayer||[],t("js",new Date),t("config","G-SHMYVQ4TGH"))}localStorage.getItem("cookieConsent")||setTimeout(()=>{t.classList.remove("hidden")},1e3),e.addEventListener("click",()=>{m({necessary:!0,analytics:!0,marketing:!0}),t.classList.add("hidden")}),r.addEventListener("click",()=>{n.classList.remove("hidden")}),a.addEventListener("click",()=>{m({necessary:!0,analytics:!1,marketing:!1}),t.classList.add("hidden")}),o.addEventListener("click",()=>{var e=new FormData(l);m({necessary:!0,analytics:"on"===e.get("analytics"),marketing:"on"===e.get("marketing")}),n.classList.add("hidden"),t.classList.add("hidden")}),s.addEventListener("click",()=>{n.classList.add("hidden")})});
